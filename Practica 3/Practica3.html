<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pac-Man WebGL</title>
<style>
  body { background:black; color:white; display:flex; flex-direction:column; align-items:center; }
  canvas { margin:20px; border:2px solid white; }
  h2 { margin:1rem; text-transform:uppercase; }
  button { padding:0.5rem 1rem; margin-top:1rem; font-size:1rem; cursor:pointer; }
</style>
</head>
<body>
<h2>Pac-Man WebGL</h2>
<canvas id="webglcanvas" width="800" height="600"></canvas>
<button id="reiniciar">Reiniciar Juego</button>

<!-- Vertex Shader -->
<script id="vs" type="vertex">
#version 300 es
precision mediump float;
uniform mat4 uMatrizProyeccion;
uniform mat4 uMatrizVista;
uniform mat4 uMatrizModelo;
layout(location = 0) in vec2 aVertices;
void main() {
    gl_Position = uMatrizProyeccion * uMatrizVista * uMatrizModelo * vec4(aVertices, 0.0, 1.0);
}
</script>

<!-- Fragment Shader -->
<script id="fs" type="fragment">
#version 300 es
precision mediump float;
uniform vec4 uColor;
out vec4 color;
void main() { color = uColor; }
</script>

<script>
let gl, canvas, programaID;
let uColor, uMatrizProyeccion, uMatrizVista, uMatrizModelo;
let MatrizProyeccion = new Array(16), MatrizVista = new Array(16), MatrizModelo = new Array(16);
let juegoTerminado = false;

const FILAS = 15, COLS = 20;
let laberinto = Array.from({length:FILAS}, ()=>Array(COLS).fill('.'));

for(let f=0; f<FILAS; f++){ laberinto[f][0]='z'; laberinto[f][COLS-1]='z'; }
for(let c=0; c<COLS; c++){ laberinto[0][c]='z'; laberinto[FILAS-1][c]='z'; }

let obstaculos = [
  [2,2],[2,3],[2,4],[2,5],[4,4],[5,4],[6,4],[7,4],
  [10,10],[10,11],[11,10],[11,11],[6,14],[7,14],[8,14],
  [3,12],[3,13],[4,12],[4,13],[5,7],[5,8],[5,9],
  [8,2],[9,2],[12,5],[12,6],[12,7],[10,16],[11,16]
];
obstaculos.forEach(p => laberinto[p[0]][p[1]]='z');

let pastillas = [[1,1],[13,18],[7,10],[2,17],[12,3]];
pastillas.forEach(p => laberinto[p[0]][p[1]]='o');

/* Matriz Identidad */
function identidad(r) {
    r[0] = 1; r[4] = 0; r[ 8] = 0; r[12] = 0;
    r[1] = 0; r[5] = 1; r[ 9] = 0; r[13] = 0;
    r[2] = 0; r[6] = 0; r[10] = 1; r[14] = 0;
    r[3] = 0; r[7] = 0; r[11] = 0; r[15] = 1;
}

/* Traslación - glTranslatef */
function traslacion(matriz, tx, ty, tz) {
    var r = new Array(16);
    r[0] = 1; r[4] = 0; r[ 8] = 0; r[12] = tx;
    r[1] = 0; r[5] = 1; r[ 9] = 0; r[13] = ty;
    r[2] = 0; r[6] = 0; r[10] = 1; r[14] = tz;
    r[3] = 0; r[7] = 0; r[11] = 0; r[15] =  1;
    multiplica(matriz, matriz, r); // M = M * T
}

/* Proyección Paralela - glOrtho */
function ortho(r, izq, der, abj, arr, cerca, lejos) {
    r[0] = 2/(der - izq); r[4] =             0; r[ 8] =                  0; r[12] =         -(der + izq)/(der - izq);
    r[1] =             0; r[5] = 2/(arr - abj); r[ 9] =                  0; r[13] =         -(arr + abj)/(arr - abj);
    r[2] =             0; r[6] =             0; r[10] = -2/(lejos - cerca); r[14] = -(lejos + cerca)/(lejos - cerca);
    r[3] =             0; r[7] =             0; r[11] =                  0; r[15] =                                1;
}

/* Multiplicación de matrices de 4 x 4 */
function multiplica(c, a, b) {
    let r = new Array(16);
    let i, j, k;
    for (i = 0; i < 4; i++){
    for (j = 0; j < 4; j++){
        let s = 0;
        for (k = 0; k < 4; k++)
        s = s + a[i + k * 4] * b[k + j * 4];
        r[i + j * 4] = s;
        }
    }
    for (i = 0; i < 16; i++)
    c[i] = r[i];
}

let sonidoWaka, musicaFondo, sonidoPerder;
function cargarSonidos(){
  sonidoWaka = new Audio("sounds/waka.mp3"); sonidoWaka.volume = 0.4;
  musicaFondo = new Audio("sounds/fondo.mp3"); musicaFondo.loop = true; musicaFondo.volume = 0.3;
  sonidoPerder = new Audio("sounds/perder.mp3"); sonidoPerder.volume = 0.6;
}

function compilaShaders(){
  const vs=gl.createShader(gl.VERTEX_SHADER);
  gl.shaderSource(vs,document.getElementById("vs").text.trim());
  gl.compileShader(vs);
  const fs=gl.createShader(gl.FRAGMENT_SHADER);
  gl.shaderSource(fs,document.getElementById("fs").text.trim());
  gl.compileShader(fs);
  programaID=gl.createProgram();
  gl.attachShader(programaID,vs);
  gl.attachShader(programaID,fs);
  gl.linkProgram(programaID);
  gl.useProgram(programaID);
}

class Cuadricula{
  constructor(gl){
    this.gl=gl;this.segmentos=20;
    // Pastilla
    this.VAO_CIRC=gl.createVertexArray();
    gl.bindVertexArray(this.VAO_CIRC);
    let v=[0,0];
    for(let i=0;i<=this.segmentos;i++){let a=i/this.segmentos*2*Math.PI;v.push(Math.cos(a),Math.sin(a));}
    let buf=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,buf);
    gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(v),gl.STATIC_DRAW);
    gl.enableVertexAttribArray(0);gl.vertexAttribPointer(0,2,gl.FLOAT,false,0,0);
    gl.bindVertexArray(null);
    // Pared
    this.VAO_PARED=gl.createVertexArray();
    gl.bindVertexArray(this.VAO_PARED);
    let vp=[0,0,1,0,1,1,0,1];
    let buf2=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,buf2);
    gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(vp),gl.STATIC_DRAW);
    gl.enableVertexAttribArray(0);gl.vertexAttribPointer(0,2,gl.FLOAT,false,0,0);
    gl.bindVertexArray(null);
  }
  dibuja(){
    for(let f=0;f<FILAS;f++)for(let c=0;c<COLS;c++){
      let tipo=laberinto[f][c];let M=MatrizModelo.slice();traslacion(M,c,f,0);
      if(tipo==='z'){gl.bindVertexArray(this.VAO_PARED);gl.uniformMatrix4fv(uMatrizModelo,false,M);gl.uniform4f(uColor,0,0,0.6,1);gl.drawArrays(gl.TRIANGLE_FAN,0,4);}
      else if(tipo==='.') {gl.bindVertexArray(this.VAO_CIRC);let copia=M.slice();traslacion(copia,0.5,0.5,0);copia[0]*=0.2;copia[5]*=0.2;gl.uniformMatrix4fv(uMatrizModelo,false,copia);gl.uniform4f(uColor,1,1,0,1);gl.drawArrays(gl.TRIANGLE_FAN,0,this.segmentos+2);}
      else if(tipo==='o'){gl.bindVertexArray(this.VAO_CIRC);let copia=M.slice();traslacion(copia,0.5,0.5,0);copia[0]*=0.35;copia[5]*=0.35;gl.uniformMatrix4fv(uMatrizModelo,false,copia);gl.uniform4f(uColor,0,0.8,1,1);gl.drawArrays(gl.TRIANGLE_FAN,0,this.segmentos+2);}
    }
  }
}

class Pacman{
  constructor(gl){
    const v=[];const cx=0.5,cy=0.5,r=0.4,seg=40;v.push(cx,cy);
    for(let i=0;i<=seg;i++){let ang=Math.PI/6+i/seg*10*Math.PI/6;v.push(cx+r*Math.cos(ang),cy+r*Math.sin(ang));}
    this.VAO=gl.createVertexArray();gl.bindVertexArray(this.VAO);
    const buf=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,buf);
    gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(v),gl.STATIC_DRAW);
    gl.enableVertexAttribArray(0);gl.vertexAttribPointer(0,2,gl.FLOAT,false,0,0);
    gl.bindVertexArray(null);
    this.fila=1;this.col=1;this.comerFantasmas=false;
  }
  dibuja(){
    let M=MatrizModelo.slice();traslacion(M,this.col,this.fila,0);
    gl.uniformMatrix4fv(uMatrizModelo,false,M);
    gl.bindVertexArray(this.VAO);
    gl.uniform4f(uColor,1,1,0,1);
    gl.drawArrays(gl.TRIANGLE_FAN,0,42);
    gl.bindVertexArray(null);
  }
}

class Fantasma{
  constructor(gl,fila,col,r,g,b){
    const v=[];const cx=0.5,cy=0.5,ra=0.4,seg=30;
    v.push(cx,cy);
    for(let i=0;i<=seg;i++){let ang=Math.PI-i/seg*Math.PI;v.push(cx+ra*Math.cos(ang),cy+ra*Math.sin(ang));}
    v.push(cx+ra,cy-0.3);v.push(cx-ra,cy-0.3);
    const baseY=cy-0.3,step=ra*2/3;
    for(let i=0;i<3;i++){v.push(cx-ra+i*step,baseY);v.push(cx-ra+i*step+step/2,baseY-0.1);v.push(cx-ra+i*step+step,baseY);}
    this.VAO=gl.createVertexArray();gl.bindVertexArray(this.VAO);
    const buf=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,buf);
    gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(v),gl.STATIC_DRAW);
    gl.enableVertexAttribArray(0);gl.vertexAttribPointer(0,2,gl.FLOAT,false,0,0);
    gl.bindVertexArray(null);
    this.fila=fila;this.col=col;this.inicioFila=fila;this.inicioCol=col;
    this.color=[r,g,b];this.modoVulnerable=false;this.activo=true;
  }
  dibuja(){
    if(!this.activo)return;
    let M=MatrizModelo.slice();traslacion(M,this.col,this.fila,0);
    gl.uniformMatrix4fv(uMatrizModelo,false,M);
    gl.bindVertexArray(this.VAO);
    if(this.modoVulnerable)gl.uniform4f(uColor,0,1,1,1);else gl.uniform4f(uColor,...this.color,1);
    gl.drawArrays(gl.TRIANGLE_FAN,0,34);gl.drawArrays(gl.TRIANGLES,34,9);
    gl.bindVertexArray(null);
  }
  mover(){
    if(!this.activo)return;
    const dirs=[[-1,0],[1,0],[0,-1],[0,1]];
    let posibles=[];
    dirs.forEach(d=>{let nf=this.fila+d[0],nc=this.col+d[1];
      if(nf>=0&&nf<FILAS&&nc>=0&&nc<COLS&&laberinto[nf][nc]!=='z')posibles.push([nf,nc]);
    });
    if(posibles.length>0){let idx=Math.floor(Math.random()*posibles.length);this.fila=posibles[idx][0];this.col=posibles[idx][1];}
  }
}

let cuadricula,pacman,fantasmas=[],tiempoFantasma=0;
let posicionesFantasmas=[[1,18],[13,1],[13,18]];

function dibujaPrincipal(){
  gl.clear(gl.COLOR_BUFFER_BIT);
  identidad(MatrizModelo);
  gl.uniformMatrix4fv(uMatrizModelo,false,MatrizModelo);
  cuadricula.dibuja();pacman.dibuja();fantasmas.forEach(f=>f.dibuja());
}

function reiniciarJuego() {
  juegoTerminado = false;
  pacman.fila = 1;
  pacman.col = 1;
  pacman.comerFantasmas = false;

  laberinto = Array.from({length: FILAS}, () => Array(COLS).fill('.'));

  for (let f = 0; f < FILAS; f++) { laberinto[f][0] = 'z'; laberinto[f][COLS-1] = 'z'; }
  for (let c = 0; c < COLS; c++) { laberinto[0][c] = 'z'; laberinto[FILAS-1][c] = 'z'; }

  obstaculos.forEach(p => laberinto[p[0]][p[1]] = 'z');
  pastillas.forEach(p => laberinto[p[0]][p[1]] = 'o');

  fantasmas.forEach(f => {
    f.fila = f.inicioFila;
    f.col = f.inicioCol;
    f.activo = true;
    f.modoVulnerable = false;
  });
}

function main(){
  canvas=document.getElementById("webglcanvas");
  gl=canvas.getContext("webgl2");
  gl.viewport(0,0,canvas.width,canvas.height);
  cargarSonidos(); 
  musicaFondo.play(); 

  compilaShaders();
  uColor=gl.getUniformLocation(programaID,"uColor");
  uMatrizProyeccion=gl.getUniformLocation(programaID,"uMatrizProyeccion");
  uMatrizVista=gl.getUniformLocation(programaID,"uMatrizVista");
  uMatrizModelo=gl.getUniformLocation(programaID,"uMatrizModelo");

  ortho(MatrizProyeccion,0,COLS,0,FILAS,-5,5);
  gl.uniformMatrix4fv(uMatrizProyeccion,false,MatrizProyeccion);
  identidad(MatrizVista);
  gl.uniformMatrix4fv(uMatrizVista,false,MatrizVista);
  gl.clearColor(0,0,0,1);

  cuadricula=new Cuadricula(gl);
  pacman=new Pacman(gl);
  fantasmas=[];posicionesFantasmas.forEach(p=>{let color=[Math.random(),Math.random(),Math.random()];fantasmas.push(new Fantasma(gl,p[0],p[1],...color));});

  document.addEventListener('keydown',(e)=>{
    if(juegoTerminado)return;
    let nf=pacman.fila,nc=pacman.col;
    if(e.key==='ArrowUp')nf++;
    if(e.key==='ArrowDown')nf--;
    if(e.key==='ArrowLeft')nc--;
    if(e.key==='ArrowRight')nc++;
    if(nf>=0&&nf<FILAS&&nc>=0&&nc<COLS&&laberinto[nf][nc]!=='z'){
      pacman.fila=nf;pacman.col=nc;
      sonidoWaka.currentTime=0;sonidoWaka.play();
      if(laberinto[nf][nc]==='.')laberinto[nf][nc]=' ';
      if(laberinto[nf][nc]==='o'){
        laberinto[nf][nc]=' ';
        pacman.comerFantasmas=true;
        fantasmas.forEach(f=>f.modoVulnerable=true);
        setTimeout(()=>{pacman.comerFantasmas=false;fantasmas.forEach(f=>f.modoVulnerable=false);},40000);
      }
    }
  });

  document.getElementById("reiniciar").onclick = ()=>{reiniciarJuego(); musicaFondo.play();};

function loop(t) {
    if (juegoTerminado) return; 

    if (!tiempoFantasma) tiempoFantasma = t;
    if (t - tiempoFantasma > 500) {
        fantasmas.forEach(f => f.mover());
        tiempoFantasma = t;
    }

    fantasmas.forEach(f => {
        if (f.fila === pacman.fila && f.col === pacman.col && f.activo && !juegoTerminado) {
        if (f.modoVulnerable) {
            f.activo = false;
        } else {
            juegoTerminado = true;
            sonidoPerder.currentTime = 0;
            sonidoPerder.play();

            setTimeout(() => {
            alert("¡Perdiste!");
            reiniciarJuego();
            musicaFondo.play();
            requestAnimationFrame(loop); 
            }, 2000);
        }
        }
    });

    if (fantasmas.every(f => !f.activo) && !juegoTerminado) {
        juegoTerminado = true;
        musicaFondo.pause();
        setTimeout(() => {
        alert("¡Ganaste!");
        reiniciarJuego();
        musicaFondo.play();
        requestAnimationFrame(loop);
        }, 3000);
    }

    dibujaPrincipal();
    if (!juegoTerminado) requestAnimationFrame(loop);
    }
  requestAnimationFrame(loop);
}
window.onload=main;
</script>
</body>
</html>
